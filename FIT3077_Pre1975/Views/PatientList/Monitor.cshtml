@model FIT3077_Pre1975.Models.PatientsList
@{
    ViewData["Title"] = "Monitor List";
}

@*<summary>
          Monitored patients list view
</summary>*@
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.8.0/Chart.bundle.min.js"></script>
<script src="https://ajax.aspnetcdn.com/ajax/jQuery/jquery-3.4.1.js" type="text/javascript"></script>
<script src="https://ajax.aspnetcdn.com/ajax/jQuery/jquery-1.10.2.min.js"></script>
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>

@*<summary>
          Function to show modal popup with patient details at (.anchorDetail) elements
    </summary>*@
<script>
    var PatientDetailPostBackURL = 'ShowDetail';

    $(function () {
        $(".anchorDetail").click(function () {

            var $buttonClicked = $(this);
            var id = $buttonClicked.attr('data-id');
            var options = { "backdrop": "static", keyboard: true };

            /// ajax GET call to get patient details with patient's ID
            $.ajax({
                type: "GET",
                url: PatientDetailPostBackURL,
                contentType: "application/json; charset=utf-8",
                data: { "Id": id },
                datatype: "json",
                success: function (data) {

                    $('#myModalContent').html(data);
                    $('#myModal').modal(options);
                    $('#myModal').modal('show');

                },
                error: function () {
                    alert("Dynamic content load failed.");
                }
            });
        });

        /// close button
        $("#closbtn").click(function () {
            $('#myModal').modal('hide');
        });
    });

</script>


@*<summary>
          Function to compute average cholesterol and highlight rows
          of patients with above average cholesterol values.
    </summary>*@
<script>
    $(document).ready(function () {
        var total = 0;
        var rowCount = 0;

        /// get all patients' cholesterol values
        $('td').each(function () {
            if ($(this).hasClass('patientvalue')) {
                var row = $(this).closest("tr")[0];
                total += parseFloat(row.cells[2].innerHTML.split()[0]);
                rowCount++;
            }
        });
        var average = total / rowCount;

        /// check if each cholesterol value is above average to add highlight class to corresponding row
        $("td").each(function () {
            if ($(this).hasClass('patientvalue')) {
                var row = $(this).closest("tr")[0];
                if (parseFloat(row.cells[2].innerHTML.split()[0]) > average) {
                    row.classList.add("highlight");
                }
            }
        });
    });
</script>


<div>
    <div class="container">
        <div class="row">
            <div class="col-sm">
                <h4>Monitored Patients</h4>
            </div>
            <div class="col-sm">
                @*Button to show monitor list in a graph*@
                <button onclick="location.href='@Url.ActionLink("HistoricalMonitor", "PatientList")'" type="button" class="btn btn-primary float-right">
                    Historical Monitor
                </button>
                <button type="button" class="btn btn-primary float-right" data-toggle="modal" data-target="#exampleModal">Show Graph</button>
            </div>
        </div>
    </div>
    <hr />
    <table class="table" id="table">
        <thead>
            <tr>
                <th scope="col">ID</th>
                <th scope="col">Name</th>
                <th scope="col">Total Cholesterol</th>
                <th scope="col">Time</th>
                <th scope="col">Systolic Blood Pressure</th>
                <th scope="col">Diastolic Blood Pressure</th>
                <th scope="col">Time</th>
                <th scope="col"></th>
                <th scope="col"></th>
            </tr>
        </thead>
        <tbody>
            @*get all patients' data from Model and generate view*@
            @if (Model != null && Model.Count > 0)
            {
                int count = 1;
                foreach (Patient patient in Model)
                {
                    <tr id=@patient.Id>
                        <td>@patient.Id</td>
                        <td>@patient.Name</td>
                        @if (!patient.ContainsObservation("Total Cholesterol"))
                        {
                            <td>No Data</td>
                            <td>No Data</td>
                        }
                        else
                        {
                            Observation cholesterol = patient.GetObservationByCodeText("Total Cholesterol");
                            <td class="patientvalue">@cholesterol.MeasurementResult.ToString()</td>
                            <td>@cholesterol.Issued</td>
                        }
                        @if (!patient.ContainsObservation("Diastolic Blood Pressure"))
                        {
                            <td>No Data</td>
                            <td>No Data</td>
                            <td>No Data</td>
                        }
                        else
                        {
                            Observation diastolic = patient.GetObservationByCodeText("Diastolic Blood Pressure");
                            Observation systolic = patient.GetObservationByCodeText("Systolic Blood Pressure");
                            <td>@systolic.MeasurementResult.ToString()</td>
                            <td>@diastolic.MeasurementResult.ToString()</td>
                            <td>@systolic.Issued</td>
                        }
                        @*patient detail button*@
                        <td>
                            <button href="javascript:void(0);" class="anchorDetail btn btn-link" data-id="@patient.Id">Details</button>
                        </td>

                        @*remove patient button*@
                        <td>
                            <button type="button" class="delete btn btn-danger" data-id="@patient.Id">Remove</button>
                        </td>
                    </tr>

                    count++;
                }
            }
        </tbody>

    </table>

    @*Modal popup to show patient extra details*@
    <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div id='myModalContent'></div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title" id="myModalLabel">Total cholesterol in mg/dL</h4>
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                </div>
                <div class="modal-body">

                    <canvas id="chBar" width="400" height="400"></canvas>

                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
    <script>
        $('#exampleModal').on('shown.bs.modal', function (event) {
            var graphLabel = [];
            var graphData = [];
            $('td').each(function () {
                if ($(this).hasClass('patientvalue')) {
                    var row = $(this).closest("tr")[0];
                    graphLabel.push(row.cells[1].innerHTML);
                    graphData.push(parseFloat(row.cells[2].innerHTML.split()[0]));
                }
            });
            var colors = ['#007bff'];
            var chBar = document.getElementById("chBar");
            var chartData = {
                labels: graphLabel,
                datasets: [{
                    data: graphData,
                    backgroundColor: colors[0]
                }]
            };
            if (graphData.length === 0) {
                chartData.datasets = [];
            }
            if (chBar) {
                new Chart(chBar, {
                    type: 'bar',
                    data: chartData,
                    options: {
                        scales: {
                            yAxes: [{
                                ticks: {
                                    beginAtZero: true
                                }
                            }]
                        },
                        legend: {
                            display: false
                        }
                    }
                });
            }
            Chart.plugins.register({
                afterDraw: function (chart) {
                    if (chartData.datasets.length === 0) {
                        // No data is present
                        var ctx = chart.chart.ctx;
                        var width = chart.chart.width;
                        var height = chart.chart.height
                        chart.clear();

                        ctx.save();
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'middle';
                        ctx.font = "16px 'Helvetica Nueue'";
                        ctx.fillText('No data to display', width / 2, height / 2);
                        ctx.restore();
                    }
                }
            });

        });
    </script>
    @*Input form for setting update interval*@
    <div style="position:relative; left:15px" class="form-group row">
        <div class="col-xs-2">
            <input type="text" id="interval" class="form-control" data-content="15">
        </div>
        <div class="input-group-append">
            <button class="btn btn-primary" type="button" id="reset">Submit</button>
        </div>
    </div>
    <small style="position:relative; top:-10px; left:10px" id="help" class="form-text text-muted">Set update interval (seconds).</small>
</div>

@*Red font css for rows of patients with above avergage cholesterol values*@
<style>
    .highlight {
        color: red;
        border-color: #1861ac;
    }
</style>


@*<summary>
          Function to update all patients' details every interval
    </summary>*@
<script type="text/javascript">

    function Update() {
        var IdList = [];

        /// get all the patients' IDs
        $('td').each(function () {
            if ($(this).hasClass('anchorDetail')) {
                IdList.push($(this).attr('data-id'));
            }
        });

        /// ajax request to update patients' details and update view accordingly
        $.ajax({
            url: '@Url.Action("ResetMonitorList", "PatientList")',
            data: { ListId: IdList },
            dataType: "json",
            type: 'POST',
            traditional: true,
        });
    }

</script>



@*<summary>
          Function to implement a timer with customizable interval
    </summary>*@
<script>
    function Timer(fn, t) {
        var timerObj = setInterval(fn, t);

        this.stop = function () {
            if (timerObj) {
                clearInterval(timerObj);
                timerObj = null;
            }
            return this;
        }

        // start timer using current settings (if it's not already running)
        this.start = function () {
            if (!timerObj) {
                this.stop();
                timerObj = setInterval(fn, t);
            }
            return this;
        }

        // start with new or original interval, stop current interval
        this.reset = function (newT = t) {
            t = newT;
            return this.stop().start();
        }
    }

    var countdown;

    /// ajax request to get current interval from AppContext
    $.ajax({
        url: '@Url.Action("GetUpdateInterval", "PatientList")',
        dataType: "json",
        data: {},
        traditional: true,
        success: function (result) {
            callback(result);
        }
    });

    /// Generate view elements (countdown timer, reset listener) with interval data
    function callback(data) {
        countdown = data;
        document.getElementById("interval").dataset.content = toString(countdown);

        /// countdown timer to update data
        var timer = new Timer(function () {
            document.getElementById("countdownTimer").innerHTML = "Data update after: " + countdown + " seconds.";
            countdown -= 1;
            if (countdown < 0) {
                Update();
                countdown = data;
            }
        }, 1000);
        timer.start();

        /// reset timer listener with new interval input
        document.getElementById("reset").addEventListener("click", function (e) {
            var newInterval = parseInt(document.getElementById("interval").value);

            /// check for appropiate new update interval
            if (isNaN(newInterval) || !(Number.isInteger(newInterval)) || (newInterval <= 5)) {
                alert("Update interval should be an integer greater than 5.");
            }

            else {
                countdown = newInterval;
                document.getElementById("interval").dataset.content = document.getElementById("interval").value;
                timer.reset(1000);

                /// update new interval to AppContext
                $.ajax({
                    url: '@Url.Action("SetUpdateInterval", "PatientList")',
                    data: { newInterval: document.getElementById("interval").value },
                    dataType: "json",
                    type: 'POST',
                    traditional: true,
                });
            }
        });
    }
</script>

@*Countdown timer div*@
<p style="position:relative; top:20px" id="countdownTimer"></p>

@*<summary>
          Function to implement remove patient button and update view and appcontext data accordingly
    </summary>*@
<script>
    $(".delete").on("click", function () {
    if (confirm("Do you want to remove this patient ?")) {
        var id = $(this).attr('data-id');
        var tr = $(this).closest('tr');
        tr.remove();

        /// ajax request to remove patient from MonitorList in AppContext using Controller method
        $.ajax({
            url: '@Url.Action("RemoveMonitorPatient", "PatientList")',
            data: { Id: id },
            dataType: "json",
            type: 'POST',
            traditional: true,
        });
    }
    });
</script>

