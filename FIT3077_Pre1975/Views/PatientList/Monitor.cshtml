@model FIT3077_Pre1975.Models.PatientsList
@{
    ViewData["Title"] = "Monitor List";
}

@*<summary>
          Monitored patients list view
    </summary>*@
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.8.0/Chart.bundle.min.js"></script>
<script src="https://ajax.aspnetcdn.com/ajax/jQuery/jquery-3.4.1.js" type="text/javascript"></script>
<script src="https://ajax.aspnetcdn.com/ajax/jQuery/jquery-1.10.2.min.js"></script>
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"></script>

@*<summary>
          Function to show modal popup with patient details at (.anchorDetail) elements
    </summary>*@
<script>
    var PatientDetailPostBackURL = 'ShowDetail';

    $(function () {
        $(".anchorDetail").click(function () {

            var $buttonClicked = $(this);
            var id = $buttonClicked.attr('data-id');
            var options = { "backdrop": "static", keyboard: true };

            /// ajax GET call to get patient details with patient's ID
            $.ajax({
                type: "GET",
                url: PatientDetailPostBackURL,
                contentType: "application/json; charset=utf-8",
                data: { "Id": id },
                datatype: "json",
                success: function (data) {

                    $('#myModalContent').html(data);
                    $('#myModal').modal(options);
                    $('#myModal').modal('show');

                },
                error: function () {
                    alert("Dynamic content load failed.");
                }
            });
        });

        /// close button
        $("#closbtn").click(function () {
            $('#myModal').modal('hide');
        });
    });

</script>


@*<summary>
          Function to compute average cholesterol and highlight rows
          of patients with above average cholesterol values.
    </summary>*@
<script>
    $(document).ready(function () {
        var total = 0;
        var rowCount = 0;

        /// get all patients' cholesterol values
        $('td').each(function () {
            if ($(this).hasClass('patientvalue')) {
                var row = $(this).closest("tr")[0];
                total += parseFloat(row.cells[2].innerHTML.split()[0]);
                rowCount++;
            }
        });
        var average = total / rowCount;

        /// check if each cholesterol value is above average to add highlight class to corresponding row
        $("td").each(function () {
            if ($(this).hasClass('patientvalue')) {
                var row = $(this).closest("tr")[0];
                if (parseFloat(row.cells[2].innerHTML.split()[0]) > average) {
                    row.cells[2].classList.add("highlight");
                }
            }
        });
    });
</script>


<div>
    @*Button to show monitor list in a graph*@
    <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#exampleModal">Show Graph</button>

    <h4>Monitored Patients</h4>
    <div>
        Select Checkbox to toggle corresponding Observations
        <div id="grpChkBox">
            <p><input type="checkbox" name="totalChol" /> Total cholesterol <input type="checkbox" name="bloodPressure" /> Blood pressure</p>
        </div>
    </div>

    <table class="table" id="table">
        <thead>
            <tr>
                <th scope="col">ID</th>
                <th scope="col">Name</th>
                <th class="totalChol" scope="col">Total Cholesterol</th>
                <th class="totalChol" scope="col">Time</th>
                <th class="bloodPressure" scope="col">Systolic Blood Pressure</th>
                <th class="bloodPressure" scope="col">Diastolic Blood Pressure</th>
                <th class="bloodPressure" scope="col">Time</th>
                <th scope="col"></th>
                <th scope="col"></th>
            </tr>
        </thead>
        <tbody>
            @*get all patients' data from Model and generate view*@
            @if (Model != null && Model.Count > 0)
            {
                int count = 1;
                foreach (Patient patient in Model)
                {
                    <tr id=@patient.Id>
                        <td>@patient.Id</td>
                        <td>@patient.Name</td>
                        @if (!patient.ContainsObservation("Total Cholesterol"))
                        {
                            <td class="totalChol">No Data</td>
                            <td class="totalChol">No Data</td>
                        }
                        else
                        {
                            Observation cholesterol = patient.GetObservationByCodeText("Total Cholesterol");
                            <td class="patientvalue totalChol">@cholesterol.MeasurementResult.ToString()</td>
                            <td class="totalChol">@cholesterol.Issued</td>
                        }
                        @if (!patient.ContainsObservation("Diastolic Blood Pressure"))
                        {
                            <td class="bloodPressure">No Data</td>
                            <td class="bloodPressure">No Data</td>
                            <td class="bloodPressure">No Data</td>
                        }
                        else
                        {
                            Observation diastolic = patient.GetObservationByCodeText("Diastolic Blood Pressure");
                            Observation systolic = patient.GetObservationByCodeText("Systolic Blood Pressure");
                            <td class="bloodPressure systolicValue">@systolic.MeasurementResult.ToString()</td>
                            <td class="bloodPressure diastolicValue">@diastolic.MeasurementResult.ToString()</td>
                            <td class="bloodPressure">@systolic.Issued</td>
                        }
                        @*patient detail button*@
                        <td>
                            <button href="javascript:void(0);" class="anchorDetail btn btn-link" data-id="@patient.Id">Details</button>
                        </td>

                        @*remove patient button*@
                        <td>
                            <button type="button" class="delete btn btn-danger" data-id="@patient.Id">Remove</button>
                        </td>
                    </tr>

                    count++;
                }
            }
        </tbody>

    </table>

    @*Modal popup to show patient extra details*@
    <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div id='myModalContent'></div>
            </div>
        </div>
    </div>

    @*Modal popup to show graph*@
    <div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title" id="myModalLabel">Total cholesterol in mg/dL</h4>
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                </div>
                <div class="modal-body">
                    <canvas id="chBar" style="width: 512px; height: 256px"></canvas>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    @*Chart render with Chart.js*@
    <script>
        $('#exampleModal').on('shown.bs.modal', function (event) {
            var graphLabel = [];
            var graphData = [];
            $('td').each(function () {
                if ($(this).hasClass('patientvalue')) {
                    var row = $(this).closest("tr")[0];
                    graphLabel.push(row.cells[1].innerHTML);
                    graphData.push(parseFloat(row.cells[2].innerHTML.split()[0]));
                }
            });

            var chBar = document.getElementById("chBar");
            var chartData = {
                labels: graphLabel,
                datasets: [{
                    data: graphData,
                    backgroundColor: '#007bff'
                }]
            };
            if (graphData.length === 0) {
                chartData.datasets = [];
            }
            if (chBar) {
                new Chart(chBar, {
                    type: 'bar',
                    data: chartData,

                    options: {
                        scales: {
                            yAxes: [{
                                ticks: {
                                    beginAtZero: true
                                }
                            }],
                            xAxes: [{
                                barPercentage: 0.3,
                                maxBarThickness: 45
                            }],
                        },
                        legend: {
                            display: false
                        }
                    }
                });
            }
            Chart.plugins.register({
                afterDraw: function (chart) {
                    if (chartData.datasets.length === 0) {
                        // No data is present
                        var ctx = chart.chart.ctx;
                        var width = chart.chart.width;
                        var height = chart.chart.height
                        chart.clear();

                        ctx.save();
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'middle';
                        ctx.font = "16px 'Helvetica Nueue'";
                        ctx.fillText('No data to display', width / 2, height / 2);
                        ctx.restore();
                    }
                }
            });

        });
    </script>
    <div class="container">
        <div class="row">
            @*Input form for setting update interval*@
            <div style="position:relative; left:15px" class="form-group col-sm">
                <div class="col-xs-2">
                    <input type="text" id="interval" placeholder="Update interval" class="form-control form-control-inline" data-content="15">
                </div>
                <div class="input-group-append">
                    <button class="btn btn-primary" type="button" id="reset">Submit</button>
                </div>
                <small style="position:relative; top:10px; left:10px" id="help" class="form-text text-muted">Set update interval (seconds).</small>
            </div>

            @*Input form for setting thresholds*@
            <div style="position:relative; left:15px" class="form-group col-sm float-right">
                <div class="col-xs-2">
                    <input type="text" id="newSystolic" placeholder="Systolic BP threshold" class="form-control form-control-inline">
                    <input type="text" id="newDiastolic" placeholder="Diastolic BP threshold" class="form-control form-control-inline">
                </div>
                <div class="input-group-append">
                    <button class="btn btn-primary" type="button" id="resetThreshold">Submit</button>
                </div>
                <small style="position:relative; top:10px; left:10px" id="help" class="form-text text-muted">Set blood pressure thresholds (mm[Hg]).</small>
                <small style="position:relative; top:20px; left:10px" id="currentThreshold" class="form-text text-muted"></small>
            </div>
        </div>
    </div>
</div>


<style>
    @*Red font for patients with above avergage cholesterol values*@ 
    .highlight {
        color: red;
        border-color: #1861ac;
        font-weight: bold;
    }
    @*Purple for BP values higher than threshold*@
    .bloodPressureHighlight {
        color: purple;
        border-color: #1861ac;
        font-weight: bold;
    }
    .form-control-inline {
        max-width: 35%;
    }
</style>


@*<summary>
          Function to update all patients' details every interval
    </summary>*@
<script type="text/javascript">
    function Update() {
        var IdList = [];

        /// get all the patients' IDs
        $('td').each(function () {
            if ($(this).hasClass('anchorDetail')) {
                IdList.push($(this).attr('data-id'));
            }
        });

        /// ajax request to update patients' details and update view accordingly
        $.ajax({
            url: '@Url.Action("ResetMonitorList", "PatientList")',
            data: { ListId: IdList },
            dataType: "json",
            type: 'POST',
            traditional: true,
        });
    }
</script>

@*<summary>
          Function to implement a timer with customizable interval
    </summary>*@
<script>
    function Timer(fn, t) {
        var timerObj = setInterval(fn, t);

        this.stop = function () {
            if (timerObj) {
                clearInterval(timerObj);
                timerObj = null;
            }
            return this;
        }

        // start timer using current settings (if it's not already running)
        this.start = function () {
            if (!timerObj) {
                this.stop();
                timerObj = setInterval(fn, t);
            }
            return this;
        }

        // start with new or original interval, stop current interval
        this.reset = function (newT = t) {
            t = newT;
            return this.stop().start();
        }
    }

    var countdown;

    /// ajax request to get current interval from AppContext
    $.ajax({
        url: '@Url.Action("GetUpdateInterval", "PatientList")',
        dataType: "json",
        data: {},
        traditional: true,
        success: function (result) {
            callbackInterval(result);
        }
    });

    /// Generate view elements (countdown timer, reset listener) with interval data
    function callbackInterval(data) {
        countdown = data;
        document.getElementById("interval").dataset.content = toString(countdown);

        /// countdown timer to update data
        var timer = new Timer(function () {
            document.getElementById("countdownTimer").innerHTML = "Data updates after: " + countdown + " seconds.";
            countdown -= 1;
            if (countdown < 0) {
                Update();
                countdown = data;
            }
        }, 1000);
        timer.start();

        /// reset timer listener with new interval input
        document.getElementById("reset").addEventListener("click", function (e) {
            var newInterval = parseInt(document.getElementById("interval").value);

            /// check for appropiate new update interval
            if (isNaN(newInterval) || !(Number.isInteger(newInterval)) || (newInterval <= 5)) {
                alert("Update interval should be an integer greater than 5.");
            }

            else {
                countdown = newInterval;
                document.getElementById("interval").dataset.content = document.getElementById("interval").value;
                timer.reset(1000);

                /// update new interval to AppContext
                $.ajax({
                    url: '@Url.Action("SetUpdateInterval", "PatientList")',
                    data: { newInterval: document.getElementById("interval").value },
                    dataType: "json",
                    type: 'POST',
                    traditional: true,
                });
            }
        });
    }
</script>

@*Countdown timer div*@
<p style="position:relative; top:20px" id="countdownTimer"></p>

@*<summary>
          Function to implement remove patient button and update view and appcontext data accordingly
    </summary>*@
<script>
    $(".delete").on("click", function () {
    if (confirm("Do you want to remove this patient ?")) {
        var id = $(this).attr('data-id');
        var tr = $(this).closest('tr');
        tr.remove();

        /// ajax request to remove patient from MonitorList in AppContext using Controller method
        $.ajax({
            url: '@Url.Action("RemoveMonitorPatient", "PatientList")',
            data: { Id: id },
            dataType: "json",
            type: 'POST',
            traditional: true,
        });
    }
    });
</script>

@*<summary>
          Function to implement dynamically toggled observations
 </summary>*@
<script>
    $(function () {
        var $chk = $("#grpChkBox input:checkbox"); // cache the selector
        var $tbl = $("#table");

        $chk.prop('checked', true); // check all checkboxes when page loads

        $chk.click(function () {
            var colToHide = $tbl.find("." + $(this).attr("name"));
            $(colToHide).toggle();
        });
    });
</script>

@*<summary>
          Function to highlight systolic and diastolic values according to x and y
 </summary>*@
<script>
    $.ajax({
        url: '@Url.Action("GetThreshold", "PatientList")',
        dataType: "json",
        data: {},
        traditional: true,
        success: function (result) {
            callback(result);
        }
    });

    /// Highlight BP values with data from AppContext
    function callback(data) {
        systolicValue = data[0];
        diastolicValue = data[1];
        var currentVal = document.getElementById("currentThreshold");
        currentVal.innerHTML = "Current thresholds: Systolic: " + systolicValue + " mm[Hg], " + "Diastolic: " + diastolicValue + " mm[Hg]."
        $("td").each(function () {
            /// Checking all systolic values to highlight
            if ($(this).hasClass('systolicValue')) {
                var row = $(this).closest("tr")[0];               
                if (parseFloat(row.cells[4].innerHTML.split()[0]) > systolicValue) {
                    row.cells[4].classList.add("bloodPressureHighlight");
                }
            }
            /// Checking all diastolic values to highlight
            if ($(this).hasClass('diastolicValue')) {
                var row = $(this).closest("tr")[0];
                if (parseFloat(row.cells[5].innerHTML.split()[0]) > diastolicValue) {
                    row.cells[5].classList.add("bloodPressureHighlight");
                }
            }
        });

        /// Set AppContext data with input value
        document.getElementById("resetThreshold").addEventListener("click", function (e) {
            var newSystolicThreshold = parseInt(document.getElementById("newSystolic").value);
            var newDiastolicThreshold = parseInt(document.getElementById("newDiastolic").value);

            /// check for appropiate new input
            if (isNaN(newSystolicThreshold) || !(Number.isInteger(newSystolicThreshold)) || (newSystolicThreshold < 0) || isNaN(newDiastolicThreshold) || !(Number.isInteger(newDiastolicThreshold)) || (newDiastolicThreshold < 0)) {
                alert("Blood pressure thresholds should be positive integers.");
            }

            else {
                /// update new thresholds to AppContext
                $.ajax({
                    url: '@Url.Action("SetThreshold", "PatientList")',
                    data: { newSystolicThreshold: document.getElementById("newSystolic").value, newDiastolicThreshold: document.getElementById("newDiastolic").value },
                    dataType: "json",
                    type: 'POST',
                    traditional: true,
                });
                var currentVal = document.getElementById("currentThreshold");
                currentVal.innerHTML = "Current thresholds: Systolic: " + newSystolicThreshold + " mm[Hg], " + "Diastolic: " + newDiastolicThreshold + " mm[Hg]."
                /// Recheck all sytolic and diastolic values to highlight
                $("td").each(function () {
                    if ($(this).hasClass('systolicValue')) {
                        var row = $(this).closest("tr")[0];
                        row.cells[4].classList.remove("bloodPressureHighlight");
                        if (parseFloat(row.cells[4].innerHTML.split()[0]) > newSystolicThreshold) {
                            row.cells[4].classList.add("bloodPressureHighlight");
                        }
                    }
                    if ($(this).hasClass('diastolicValue')) {
                        var row = $(this).closest("tr")[0];
                        row.cells[5].classList.remove("bloodPressureHighlight");
                        if (parseFloat(row.cells[5].innerHTML.split()[0]) > newDiastolicThreshold) {
                            row.cells[5].classList.add("bloodPressureHighlight");
                        }
                    }
                });
            }
        });
    }
</script>